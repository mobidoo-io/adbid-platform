#!/bin/bash

# ========================================
# Ð˜Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Kamal Ð´Ð»Ñ AdBid
# ========================================

set -e

# Ð¦Ð²ÐµÑ‚Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘   ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Kamal Ð´Ð»Ñ AdBid            â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð²Ð²Ð¾Ð´Ð°
prompt_input() {
    local prompt="$1"
    local var_name="$2"
    local default="$3"
    
    if [ -n "$default" ]; then
        read -p "$prompt [$default]: " input
        eval "$var_name=\${input:-$default}"
    else
        read -p "$prompt: " input
        eval "$var_name=\$input"
    fi
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ
prompt_password() {
    local prompt="$1"
    local var_name="$2"
    
    echo -n "$prompt: "
    read -s input
    echo ""
    eval "$var_name=\$input"
}

echo -e "${YELLOW}ðŸ“‹ Ð¨Ð°Ð³ 1: Docker Hub Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°${NC}"
echo "Ð’Ð°Ð¼ Ð¿Ð¾Ð½Ð°Ð´Ð¾Ð±Ð¸Ñ‚ÑÑ:"
echo "1. Docker Hub username"
echo "2. Docker Hub Access Token (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ) Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ"
echo ""
echo "Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Access Token: https://hub.docker.com/settings/security"
echo ""

prompt_input "Docker Hub username" DOCKER_USERNAME ""

if [ -z "$DOCKER_USERNAME" ]; then
    echo -e "${RED}âŒ Docker Hub username Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½${NC}"
    exit 1
fi

prompt_password "Docker Hub password/token" DOCKER_PASSWORD

if [ -z "$DOCKER_PASSWORD" ]; then
    echo -e "${RED}âŒ Docker Hub password/token Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½${NC}"
    exit 1
fi

echo ""
echo -e "${YELLOW}ðŸ“‹ Ð¨Ð°Ð³ 2: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°${NC}"

SERVER_IP="165.227.11.220"
DOMAIN="adbid.me"
EMAIL="admin@adbid.me"

prompt_input "IP Ð°Ð´Ñ€ÐµÑ ÑÐµÑ€Ð²ÐµÑ€Ð°" SERVER_IP "$SERVER_IP"
prompt_input "Ð”Ð¾Ð¼ÐµÐ½" DOMAIN "$DOMAIN"
prompt_input "Email Ð´Ð»Ñ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°" EMAIL "$EMAIL"

echo ""
echo -e "${YELLOW}ðŸ“‹ Ð¨Ð°Ð³ 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°${NC}"

echo -n "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº $SERVER_IP... "
if ssh -o ConnectTimeout=5 -o BatchMode=yes root@$SERVER_IP "echo 'OK'" &>/dev/null; then
    echo -e "${GREEN}âœ… SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚${NC}"
else
    echo -e "${RED}âŒ SSH Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚${NC}"
    echo ""
    echo "ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ:"
    echo "  ssh-copy-id root@$SERVER_IP"
    echo ""
    read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ñ€Ð°Ð²Ð½Ð¾? (y/n): " continue_anyway
    if [ "$continue_anyway" != "y" ]; then
        exit 1
    fi
fi

echo ""
echo -e "${YELLOW}ðŸ“‹ Ð¨Ð°Ð³ 4: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸${NC}"

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .env
cat > .env << EOF
# Kamal deployment environment variables
# Generated by setup-kamal.sh on $(date)

# Docker Registry credentials
KAMAL_REGISTRY_USERNAME=$DOCKER_USERNAME
KAMAL_REGISTRY_PASSWORD=$DOCKER_PASSWORD

# Server configuration
SERVER_IP=$SERVER_IP
DOMAIN=$DOMAIN

# Let's Encrypt email for SSL certificates
LETSENCRYPT_EMAIL=$EMAIL

# Optional: Database credentials (if using)
# DATABASE_URL=postgres://user:password@host:5432/dbname

# Optional: API keys
# API_KEY=your_api_key_here
EOF

echo -e "${GREEN}âœ… .env Ñ„Ð°Ð¹Ð» Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½${NC}"

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ config/deploy.yml
sed -i.bak "s|image: .*|image: $DOCKER_USERNAME/adbid|g" config/deploy.yml
sed -i.bak "s|165.227.11.220|$SERVER_IP|g" config/deploy.yml
sed -i.bak "s|Host(\`adbid.me\`, \`www.adbid.me\`)|Host(\`$DOMAIN\`, \`www.$DOMAIN\`)|g" config/deploy.yml
sed -i.bak "s|admin@adbid.me|$EMAIL|g" config/deploy.yml

echo -e "${GREEN}âœ… config/deploy.yml Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½${NC}"

echo ""
echo -e "${YELLOW}ðŸ“‹ Ð¨Ð°Ð³ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker${NC}"

echo -n "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Docker login... "
if echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin &>/dev/null; then
    echo -e "${GREEN}âœ… Docker login ÑƒÑÐ¿ÐµÑˆÐµÐ½${NC}"
else
    echo -e "${RED}âŒ Docker login Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ${NC}"
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ username Ð¸ password/token"
    exit 1
fi

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘   âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!      â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${CYAN}Ð§Ñ‚Ð¾ Ð´Ð°Ð»ÑŒÑˆÐµ:${NC}"
echo ""
echo "1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Kamal (ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½):"
echo -e "   ${YELLOW}brew install kamal${NC}"
echo "   Ð¸Ð»Ð¸"
echo -e "   ${YELLOW}gem install kamal${NC}"
echo ""
echo "2. Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Kamal:"
echo -e "   ${YELLOW}./kamal-deploy.sh init${NC}"
echo ""
echo "3. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ ÑÐµÑ€Ð²ÐµÑ€ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ñ€Ð°Ð·):"
echo -e "   ${YELLOW}./kamal-deploy.sh setup${NC}"
echo ""
echo "4. Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð´ÐµÐ¿Ð»Ð¾Ð¹:"
echo -e "   ${YELLOW}./kamal-deploy.sh deploy${NC}"
echo ""
echo -e "${CYAN}ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ:${NC}"
echo "  Docker Hub: $DOCKER_USERNAME/adbid"
echo "  Server: $SERVER_IP"
echo "  Domain: $DOMAIN"
echo "  SSL Email: $EMAIL"
echo ""

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ ÑˆÐ¿Ð°Ñ€Ð³Ð°Ð»ÐºÑƒ
cat > KAMAL_CHEATSHEET.txt << EOF
=== KAMAL QUICK COMMANDS ===

Installation:
  brew install kamal
  OR
  gem install kamal

First time setup:
  ./kamal-deploy.sh init
  ./kamal-deploy.sh setup
  ./kamal-deploy.sh deploy

Daily usage:
  ./kamal-deploy.sh deploy    # Full deploy
  ./kamal-deploy.sh quick     # Quick redeploy
  ./kamal-deploy.sh rollback  # Rollback
  ./kamal-deploy.sh logs      # View logs
  ./kamal-deploy.sh status    # Check status

Configuration:
  Docker Hub: $DOCKER_USERNAME/adbid
  Server: $SERVER_IP
  Domain: https://$DOMAIN
EOF

echo -e "${GREEN}ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° ÑˆÐ¿Ð°Ñ€Ð³Ð°Ð»ÐºÐ°: KAMAL_CHEATSHEET.txt${NC}"