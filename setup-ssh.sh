#!/bin/bash

echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É AdBid"
echo "========================================="
echo ""

SERVER_IP="165.227.11.220"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª—é—á–∞
if [ ! -f ~/.ssh/id_rsa ]; then
    echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ SSH –∫–ª—é—á–∞..."
    ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" -C "adbid-deploy"
    echo "‚úÖ SSH –∫–ª—é—á —Å–æ–∑–¥–∞–Ω"
else
    echo "‚úÖ SSH –∫–ª—é—á —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

echo ""
echo "üìã –í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á:"
echo "========================"
cat ~/.ssh/id_rsa.pub
echo "========================"
echo ""

echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á –≤—ã—à–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä!"
echo ""
echo "–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞:"
echo ""
echo "1Ô∏è‚É£  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å root):"
echo "   ssh-copy-id root@$SERVER_IP"
echo ""
echo "2Ô∏è‚É£  –ß–µ—Ä–µ–∑ DigitalOcean –ø–∞–Ω–µ–ª—å:"
echo "   - –í–æ–π–¥–∏—Ç–µ –≤ DigitalOcean"
echo "   - Droplets ‚Üí –≤–∞—à —Å–µ—Ä–≤–µ—Ä ‚Üí Access ‚Üí Launch Droplet Console"
echo "   - –í—ã–ø–æ–ª–Ω–∏—Ç–µ: echo '–í–ê–®_–ö–õ–Æ–ß' >> ~/.ssh/authorized_keys"
echo ""
echo "3Ô∏è‚É£  –í—Ä—É—á–Ω—É—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
echo "   ssh root@$SERVER_IP"
echo "   mkdir -p ~/.ssh"
echo "   echo '–í–ê–®_–ö–õ–Æ–ß' >> ~/.ssh/authorized_keys"
echo "   chmod 600 ~/.ssh/authorized_keys"
echo ""

# –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
read -p "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏? (y/n): " try_auto

if [ "$try_auto" = "y" ]; then
    echo ""
    echo "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å root –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ $SERVER_IP"
    ssh-copy-id root@$SERVER_IP
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!"
        echo ""
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
        if ssh -o ConnectTimeout=5 root@$SERVER_IP "echo 'SSH —Ä–∞–±–æ—Ç–∞–µ—Ç!'" 2>/dev/null; then
            echo "‚úÖ SSH –¥–æ—Å—Ç—É–ø –Ω–∞—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
            echo ""
            echo "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–ø–ª–æ–π:"
            echo "./auto-deploy.sh"
        fi
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
        echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –∏–∑ —Ä—É—á–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ –≤—ã—à–µ"
    fi
fi