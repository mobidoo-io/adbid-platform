name: Deploy to DigitalOcean

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

env:
  SERVER_IP: 165.227.11.220
  DOMAIN: adbid.me

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests (if any)
      run: npm test --if-present
      continue-on-error: true
    
    - name: Build project
      run: npm run build
    
    - name: Create deployment package
      run: |
        mkdir -p deploy_package
        cp -r dist/* deploy_package/ 2>/dev/null || true
        cp -r *.html deploy_package/ 2>/dev/null || true
        cp -r Dashboard deploy_package/ 2>/dev/null || true
        cp nginx.conf deploy_package/ 2>/dev/null || true
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð²ÐµÑ€ÑÐ¸Ð¸
        echo '{
          "version": "'$GITHUB_SHA'",
          "deployed": "'$(date -u +"%Y-%m-%d %H:%M:%S UTC")'",
          "branch": "'$GITHUB_REF_NAME'",
          "run_id": "'$GITHUB_RUN_ID'"
        }' > deploy_package/version.json
        
        tar -czf deploy.tar.gz -C deploy_package .
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts
    
    - name: Deploy to server
      run: |
        # Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²
        scp deploy.tar.gz root@${{ env.SERVER_IP }}:/tmp/
        scp nginx.conf root@${{ env.SERVER_IP }}:/tmp/ 2>/dev/null || true
        
        # Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ
        ssh root@${{ env.SERVER_IP }} << 'ENDSSH'
          set -e
          
          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
          mkdir -p /var/www/adbid
          mkdir -p /var/www/backups
          
          cd /var/www/adbid
          
          # Ð‘ÐµÐºÐ°Ð¿ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸
          if [ -d "current" ]; then
            BACKUP_NAME="backup-$(date +'%Y%m%d-%H%M%S')"
            cp -r current /var/www/backups/${BACKUP_NAME}
            
            # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð±ÐµÐºÐ°Ð¿Ð¾Ð²
            cd /var/www/backups
            ls -t | tail -n +6 | xargs -r rm -rf
            cd /var/www/adbid
          fi
          
          # Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸
          rm -rf new_version
          mkdir new_version
          tar -xzf /tmp/deploy.tar.gz -C new_version/
          
          # ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¹
          if [ -d "current" ]; then
            rm -rf previous
            mv current previous
          fi
          mv new_version current
          
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð²
          chown -R www-data:www-data /var/www/adbid
          chmod -R 755 /var/www/adbid
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ nginx ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð½Ð¾Ð²Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
          if [ -f "/tmp/nginx.conf" ]; then
            cp /tmp/nginx.conf /etc/nginx/sites-available/adbid
            nginx -t && systemctl reload nginx
          fi
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
          rm -f /tmp/deploy.tar.gz
          rm -f /tmp/nginx.conf
          
          echo "Deployment completed successfully!"
        ENDSSH
    
    - name: Check deployment
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÑÐ°Ð¹Ñ‚Ð°
        sleep 5
        if curl -f -s -o /dev/null "http://${{ env.DOMAIN }}"; then
          echo "âœ… Site is accessible at http://${{ env.DOMAIN }}"
        elif curl -f -s -o /dev/null "http://${{ env.SERVER_IP }}"; then
          echo "âœ… Site is accessible at http://${{ env.SERVER_IP }}"
        else
          echo "âŒ Site is not accessible!"
          exit 1
        fi
    
    - name: Notify success
      if: success()
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "View site: http://${{ env.DOMAIN }}"
    
    - name: Rollback on failure
      if: failure()
      run: |
        ssh root@${{ env.SERVER_IP }} << 'ENDSSH'
          cd /var/www/adbid
          if [ -d "previous" ]; then
            rm -rf current
            mv previous current
            systemctl reload nginx
            echo "âš ï¸ Rolled back to previous version"
          fi
        ENDSSH